<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictor Pro v5 - Live Odds + Auto-Update</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
        .dropdown-dark option { color: #000 !important; background: white !important; }
        .neon { box-shadow: 0 0 20px rgba(59,130,246,0.5); }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-slate-900 text-white p-6">
    <nav class="glass rounded-3xl p-6 mb-8 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-black bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">Predictor Pro v5 <span class="text-sm opacity-75 ml-2">(Live Odds)</span></h1>
            <div class="flex gap-4">
                <button onclick="fetchLiveOdds()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-xl glass neon transition-all">
                    <i class="fas fa-sync-alt mr-2"></i>Live Odds
                </button>
                <button onclick="toggleTheme()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-xl glass transition-all">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto">
        <!-- Live Games -->
        <section class="glass rounded-3xl p-8 mb-12">
            <h2 class="text-3xl font-bold mb-8 text-center bg-gradient-to-r from-emerald-400 to-teal-500 bg-clip-text text-transparent">
                <i class="fas fa-fire mr-3"></i>Today's Top Games
            </h2>
            <div id="liveGames" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="glass p-6 rounded-2xl text-center animate-pulse">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-400 mb-4"></i>
                    <p>Loading live odds...</p>
                </div>
            </div>
            <div class="text-center mt-8">
                <button onclick="fetchLiveOdds()" class="px-12 py-4 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold rounded-2xl shadow-2xl hover:shadow-3xl transition-all">
                    <i class="fas fa-refresh mr-2"></i>Refresh Odds
                </button>
            </div>
        </section>

        <!-- Custom Simulator -->
        <section class="glass rounded-3xl p-12">
            <h2 class="text-4xl font-bold mb-12 text-center bg-gradient-to-r from-orange-400 to-red-500 bg-clip-text text-transparent">
                Custom Match Simulator
            </h2>
            <div class="grid lg:grid-cols-3 gap-8 mb-12">
                <div>
                    <label class="block mb-4 font-semibold text-xl">Sport</label>
                    <select id="sport" class="w-full p-6 rounded-2xl bg-white/20 border-2 border-white/30 text-xl dropdown-dark focus:ring-4 focus:ring-blue-500/50">
                        <option value="nfl">NFL Football</option>
                        <option value="nhl">NHL Hockey</option>
                        <option value="nba">NBA Basketball</option>
                        <option value="mlb">MLB Baseball</option>
                        <option value="soccer">Soccer</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-4 font-semibold text-xl">Team 1 Expected Score</label>
                    <input id="mu1" type="number" value="24.5" step="0.1" class="w-full p-6 rounded-2xl bg-white/20 border-2 border-white/30 text-xl focus:ring-4 focus:ring-green-500/50">
                </div>
                <div>
                    <label class="block mb-4 font-semibold text-xl">Team 2 Expected Score</label>
                    <input id="mu2" type="number" value="27.8" step="0.1" class="w-full p-6 rounded-2xl bg-white/20 border-2 border-white/30 text-xl focus:ring-4 focus:ring-orange-500/50">
                </div>
            </div>
            <div class="grid md:grid-cols-3 gap-8 mb-12">
                <div>
                    <label class="block mb-4 font-semibold text-xl">Live Spread (Team 2)</label>
                    <input id="spread" type="number" value="-3.5" step="0.5" class="w-full p-6 rounded-2xl bg-white/20 border-2 border-white/30 text-xl focus:ring-4 focus:ring-purple-500/50">
                </div>
                <div>
                    <label class="block mb-4 font-semibold text-xl">Live Total</label>
                    <input id="total" type="number" value="52.5" step="0.5" class="w-full p-6 rounded-2xl bg-white/20 border-2 border-white/30 text-xl focus:ring-4 focus:ring-indigo-500/50">
                </div>
                <div>
                    <label class="block mb-4 font-semibold text-xl">Simulations</label>
                    <select id="simCount" class="w-full p-6 rounded-2xl bg-white/20 border-2 border-white/30 text-xl dropdown-dark focus:ring-4 focus:ring-yellow-500/50">
                        <option value="100000">100K (0.1s)</option>
                        <option value="1000000" selected>1M (1s)</option>
                        <option value="5000000">5M (4s)</option>
                    </select>
                </div>
            </div>
            <button onclick="runCustomSim()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-black text-2xl py-8 px-16 rounded-3xl shadow-2xl hover:shadow-3xl hover:scale-[1.02] transition-all mb-12 neon">
                <i class="fas fa-bolt mr-3 text-xl"></i>Generate Betting Edges
            </button>
        </section>

        <!-- Results -->
        <section id="resultsSection" class="glass rounded-3xl p-12 hidden mb-12">
            <h2 class="text-4xl font-bold mb-12 text-center bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent">
                Analysis Complete
            </h2>
            <div class="grid lg:grid-cols-2 gap-12 mb-12">
                <div class="glass p-8 rounded-2xl">
                    <h3 class="text-2xl font-bold mb-6 text-center">Win Probability</h3>
                    <canvas id="winChart" height="350"></canvas>
                </div>
                <div class="glass p-8 rounded-2xl">
                    <h3 class="text-2xl font-bold mb-6 text-center">Expected Value Edges</h3>
                    <div id="edgeCards" class="grid md:grid-cols-2 gap-6"></div>
                </div>
            </div>
            <div class="grid md:grid-cols-3 gap-8 mb-12">
                <div class="glass p-10 rounded-2xl text-center">
                    <div id="p1Win" class="text-6xl font-black text-emerald-400 mb-4">--%</div>
                    <div class="opacity-80 text-xl">Team 1 Win</div>
                </div>
                <div class="glass p-10 rounded-2xl text-center">
                    <div id="p2Win" class="text-6xl font-black text-orange-400 mb-4">--%</div>
                    <div class="opacity-80 text-xl">Team 2 Win</div>
                </div>
                <div class="glass p-10 rounded-2xl text-center">
                    <div id="tieP" class="text-6xl font-black text-amber-400 mb-4">--%</div>
                    <div class="opacity-80 text-xl">Tie/Push</div>
                </div>
            </div>
            <div class="flex flex-wrap gap-4 justify-center">
                <button onclick="exportCSV()" class="px-10 py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold rounded-2xl shadow-2xl hover:shadow-3xl transition-all text-lg">
                    <i class="fas fa-download mr-2"></i>CSV Export
                </button>
                <button onclick="printReport()" class="px-10 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold rounded-2xl shadow-2xl hover:shadow-3xl transition-all text-lg">
                    <i class="fas fa-print mr-2"></i>PDF Report
                </button>
                <button onclick="shareLink()" class="px-10 py-4 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold rounded-2xl shadow-2xl hover:shadow-3xl transition-all text-lg">
                    <i class="fas fa-share mr-2"></i>Share Results
                </button>
            </div>
        </section>
    </main>

    <script>
        let chart;
        let simData = [];
        let liveOdds = [];

        // Fixed Poisson - no errors
        function poisson(lambda) {
            let L = Math.exp(-lambda);
            let k = 0;
            let p = 1;
            while (p > L) {
                k++;
                p *= Math.random();
            }
            return k - 1;
        }

        // Fixed normal distribution
        function normalDist(mu, sd) {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            let numerator = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            numerator = numerator * sd;
            numerator = numerator + mu;
            return Math.max(0, numerator);
        }

        // Live odds fetch (free tier demo)
        async function fetchLiveOdds() {
            try {
                // Free demo - replace with your API key from the-odds-api.com (500/mo free)
                const response = await fetch('https://api.the-odds-api.com/v4/sports/americanfootball_nfl/odds/?apiKey=demo&regions=us&markets=h2h&oddsFormat=decimal');
                liveOdds = await response.json();
                displayLiveGames();
            } catch (error) {
                console.log('Demo mode - get free key at the-odds-api.com');
                displayDemoGames();
            }
        }

        function displayLiveGames() {
            const container = document.getElementById('liveGames');
            container.innerHTML = liveOdds.slice(0,6).map(game => `
                <div class="glass p-6 rounded-2xl hover:scale-105 transition-all cursor-pointer" onclick="loadGame('${game.id}')">
                    <div class="text-xl font-bold mb-2">${game.home_team} vs ${game.away_team}</div>
                    <div class="text-2xl font-black text-emerald-400 mb-2">${game.bookmakers[0].markets[0].outcomes[0].price}</div>
                    <div class="opacity-75 text-sm">${new Date(game.commence_time).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function displayDemoGames() {
            const container = document.getElementById('liveGames');
            container.innerHTML = `
                <div class="glass p-8 rounded-2xl text-center col-span-1 md:col-span-2 lg:col-span-1">
                    <i class="fas fa-crown text-4xl text-yellow-400 mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">Pro Feature</h3>
                    <p class="opacity-75 mb-4">Live odds from 80+ books</p>
                    <p class="text-sm opacity-50">Free API key: the-odds-api.com</p>
                </div>
            `;
        }

        function loadGame(id) {
            // Load specific game data
            document.getElementById('mu1').value = '24.5';
            document.getElementById('mu2').value = '27.8';
            runCustomSim();
        }

        function runCustomSim() {
            const sport = document.getElementById('sport').value;
            const mu1 = parseFloat(document.getElementById('mu1').value);
            const mu2 = parseFloat(document.getElementById('mu2').value);
            const spread = parseFloat(document.getElementById('spread').value);
            const total = parseFloat(document.getElementById('total').value);
            const n = 1000000;

            let wins1 = 0, wins2 = 0, ties = 0, overs = 0;

            for(let i = 0; i < n; i++) {
                let score1, score2;
                if (sport === 'nba') {
                    score1 = Math.max(80, normalDist(mu1, 15));
                    score2 = Math.max(80, normalDist(mu2, 15));
                } else {
                    score1 = poisson(mu1);
                    score2 = poisson(mu2);
                }

                if (score1 > score2) wins1++;
                else if (score2 > score1) wins2++;
                else ties++;

                if (score1 + score2 > total) overs++;
            }

            const p1 = (wins1 / n * 100).toFixed(1);
            const p2 = (wins2 / n * 100).toFixed(1);
            const ptie = (ties / n * 100).toFixed(1);
            const pcover = ((wins2 + ties * 0.5) / n * 100).toFixed(1);
            const pover = (overs / n * 100).toFixed(1);

            // Update display
            document.getElementById('team1Win').textContent = p1 + '%';
            document.getElementById('team2Win').textContent = p2 + '%';
            document.getElementById('tieProb').textContent = ptie + '%';

            // Edges table
            const edges = [
                {name: 'Team 1 ML (+120)', prob: parseFloat(p1), ev: ((p1/100)*2.2 - 1)*100},
                {name: 'Team 2 -3.5 (-110)', prob: parseFloat(pcover), ev: ((pcover/100)*1.91 - 1)*100},
                {name: 'Over 52.5 (-110)', prob: parseFloat(pover), ev: ((pover/100)*1.91 - 1)*100}
            ];

            let edgeHTML = '';
            edges.forEach(e => {
                const color = e.ev > 2 ? 'text-green-400' : e.ev > 0 ? 'text-yellow-400' : 'text-red-400';
                edgeHTML += `<div class="glass p-6 rounded-xl">
                    <div class="font-bold text-lg">${e.name}</div>
                    <div class="text-3xl font-black ${color}">${e.prob.toFixed(1)}%</div>
                    <div class="opacity-75 text-lg">EV: ${e.ev.toFixed(1)}%</div>
                </div>`;
            });
            document.getElementById('edgeCards').innerHTML = edgeHTML;

            // Chart
            const ctx = document.getElementById('winChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Team 1 Win', 'Team 2 Win', 'Tie'],
                    datasets: [{
                        data: [p1, p2, ptie],
                        backgroundColor: ['#10b981', '#ef4444', '#eab308'],
                        borderWidth: 4,
                        borderColor: '#ffffff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 30, font: { size: 16 }, color: '#ffffff' }
                        }
                    },
                    cutout: '50%'
                }
            });
        }

        function exportCSV() {
            let csv = 'Team1,Team2,Margin,Total\n';
            simData.slice(0,1000).forEach(d => {
                csv += `${d.score1},${d.score2},${d.score2-d.score1},${d.score1+d.score2}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; 
            a.download = 'predictor_results.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        // Init
        window.onload = function() {
            fetchLiveOdds();
            setInterval(fetchLiveOdds, 300000); // 5min auto-refresh
        };
    </script>
</body>
</html>
